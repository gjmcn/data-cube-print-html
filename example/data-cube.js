!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e._data_cube_helper=t()}(this,function(){"use strict";var e;"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;{const t=(function(e,t){var r;e.exports=(function(e){{const t={dimName:["row","column","page"],shortDimName:["row","col","page"],lettersArray:["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"],copyArray:e=>{const t=e.length,r=new Array(t);for(let n=0;n<t;n++)r[n]=e[n];return r},equalArray:(e,t)=>{var r=e.length;if(r!==t.length)return!1;for(var n=0;n<r;n++)if(e[n]!==t[n])return!1;return!0},equalArrayOfArray:(e,r)=>{if(!Array.isArray(e)||!Array.isArray(r))return!1;const n=e.length;if(n!==r.length)return!1;for(let s=0;s<n;s++){if(!Array.isArray(e[s])||!Array.isArray(r[s]))return!1;if(!t.equalArray(e[s],r[s]))return!1}return!0},copyMap:e=>{const t=new Map;for(let[r,n]of e.entries())t.set(r,n);return t},equalMap:(e,t)=>{if(e.size!==t.size)return!1;const r=t.entries();for(let[t,n]of e.entries()){let[e,s]=r.next().value;if(t!==e||n!==s)return!1}return!0},toMap:(...e)=>{const t=e.length;if(t%2!=0)throw Error("even number of arguments expected");const r=new Map;for(let n=0;n<t;n+=2)r.set(e[n],e[n+1]);if(r.size!==t/2)throw Error("duplicate key");return r},keyMap:e=>{const t=e.length,r=new Map;for(let n=0;n<t;n++){let t=e[n];if(void 0===t||null===t)throw Error(`invalid key: ${t}`);r.set(t,n)}if(r.size!==t)throw Error("duplicate key");return r},simpleRange:e=>{e=r.nonNegInt(e);for(var t=new Array(e),n=0;n<e;n++)t[n]=n;return t},shuffle:e=>{e=r.posInt(e);var t,n=new Array(e);n[0]=0;for(var s=1;s<e;s++)t=Math.floor(Math.random()*(s+1)),n[s]=n[t],n[t]=s;return n},fill:(e,t)=>{const r=e.length;for(let n=0;n<r;n++)e[n]=t;return e},fillEW:(e,t)=>{const r=e.length;if(t.length!==r)throw Error("shape mismatch");for(let n=0;n<r;n++)e[n]=t[n];return e},isSingle:e=>!Array.isArray(e)||1===e.length,toArray:e=>Array.isArray(e)?e:[e],polarize:e=>Array.isArray(e)?1===e.length?[e[0],!0]:[e,!1]:[e,!0],def:(e,t)=>void 0===e?t:e,addArrayMethod:(e,t)=>{if(e in Array.prototype)throw Error(e+" is already a property of Array.protoype");Object.defineProperty(Array.prototype,e,{value:t,configurable:!0,enumerable:!1,writable:!0})},ensure:(e,t)=>{e[t]||Object.defineProperty(e,t,{value:new Array(3),configurable:!0,writable:!0})},ensureKey:e=>{t.ensure(e,"_k")},ensureLabel:e=>{t.ensure(e,"_l")},squeezeKey:e=>{e._k[0]||e._k[1]||e._k[2]||delete e._k},squeezeLabel:e=>{e._l[0]||e._l[1]||e._l[2]||delete e._l},copyKey:(e,r,n)=>{if(e._k)for(let s=0;s<3;s++)s!==n&&e._k[s]&&(t.ensureKey(r),r._k[s]=t.copyMap(e._k[s]))},copyLabel:(e,r,n)=>{if(e._l)for(let s=0;s<3;s++)s!==n&&e._l[s]&&(t.ensureLabel(r),r._l[s]=e._l[s])},skeleton:(e,r,n)=>{const s=[];return s._s=t.copyArray(e._s),t.copyKey(e,s,r),t.copyLabel(e,s,n),s},nni:(e,t)=>{if(!Number.isInteger(e))throw Error("integer expected");if(e>=t||e<-t)throw Error("index out of bounds");return e<0?e+t:e},rangeKey:(e,t,r)=>{const n=new Array(r.size);let s=null===e||void 0===e?1:0;const i=null!==t&&void 0!==t;let o=0;for(let l of r.keys())if(s){if(n[o++]=l,i&&l===t){s=2;break}}else if(l===e){if(n[o++]=l,i&&e===t){s=2;break}s=1}if(0===s)throw Error("start key does not exist");if(i&&1===s)throw Error("end-key does not exist or is before start-key");return n.length=o,n},firstKey:(e,t)=>{const r=new Array(e);let n=0;for(let s of t.keys()){if(n===e)break;r[n++]=s}return r.length=n,r},rangeInd:(e,t)=>{if(t<e)throw Error("end less than start");const r=new Array(t-e+1);let n=0;for(let s=e;s<=t;s++)r[n++]=s;return r},indInd:(e,r)=>{const n=e.length,s=new Array(n);for(let i=0;i<n;i++)s[i]=t.nni(e[i],r);return s},keyInd:(e,t)=>{const r=e.length,n=new Array(r);for(let s=0;s<r;s++){let r=t.get(e[s]);if(void 0===r)throw Error("key does not exist");n[s]=r}return n}};{const e=t.lettersArray,r=new Map;for(let t=0;t<e.length;t++)r.set(e[t],t);t.lettersMap=r}const r={nonNegInt:e=>{if(!Number.isInteger(e)||e<0)throw Error("non-negative integer expected");return e},posInt:e=>{if(!Number.isInteger(e)||e<=0)throw Error("positive integer expected");return e},number:e=>{if("number"!=typeof e)throw Error("number expected");return e},dim:e=>{if(void 0===(e=r.single(e)))return 0;if(0!==e&&1!==e&&2!==e)throw Error("invalid dimension");return e},single:e=>{if(Array.isArray(e)){if(1!==e.length)throw Error("singleton expected");return e[0]}return e},func:e=>{if("function"!=typeof e)throw Error("function expected");return e},argRange:(e,t,r)=>{const n=e.length;if(n<t)throw Error("too few arguments");if(n>r)throw Error("too many arguments");return n},timer:e=>{const t=process.hrtime();e();const r=process.hrtime(t);return Math.round((1e9*r[0]+r[1])/1e6)},dataMatrix:e=>{if(1!==e._s[2]||0===e._s[1])throw Error("matrix with at least 1 column expected")}};t.assert=r,e.exports=t}}(r={exports:{}}),r.exports)}(e={exports:{}},e.exports),e.exports),{assert:r,fill:n,fillEW:s,addArrayMethod:i,squeezeKey:o,squeezeLabel:l,keyMap:a,isSingle:h,polarize:u,def:f,toArray:c,copyArray:_,copyMap:d,ensureKey:g,ensureLabel:y,nni:p,copyKey:m,copyLabel:b,skeleton:w}=t;["_data_cube","_s","_k","_l"].forEach(e=>{if(e in Array.prototype)throw Error(e+" is a property of Array.protoype")});const k=e=>{Object.defineProperty(e,"length",{writable:!1}),Object.defineProperty(e,"_data_cube",{value:!0}),Object.defineProperty(e,"_s",{value:[e.length,1,1],writable:!0})};i("toCube",function(){return this._data_cube||k(this),this}),i("compare",function(e,n){if(this._data_cube||k(this),n=f(r.single(n),!0),this===e)return this;let s;if(s=n?e=>{throw Error(e)}:()=>!1,!Array.isArray(e))return s("cube compared to non-array");const i=this.length;if(i!==e.length)return s("number of entries not equal");for(let t=0;t<i;t++)if(this[t]!==e[t])return s(`entries at vector index ${t} not equal`);if(e._data_cube){if(!t.equalArray(this._s,e._s))return s("shape not equal");const r=this._k,n=e._k;if(r){if(!n)return s("keys-indices");for(let e=0;e<3;e++)if(r[e]){if(!n[e])return s(`keys-indices, ${t.dimName[e]}s`);if(!t.equalMap(r[e],n[e]))return s(`${t.dimName[e]} keys not equal`)}else if(n[e])return s("indices-keys")}else if(n)return s("indices-keys");const i=this._l,o=e._l;if(i){if(!o)return s("labels not equal or not used on same dimensions");if(!t.equalArray(i,o))return s("labels not equal or not used on same dimensions")}else if(o)return s("labels not equal or not used on same dimensions")}else{if(1!==this._s[1]||1!==this._s[2])return s("shape not equal");if(this._k)return s("keys-indices");if(this._l)return s("labels not equal or not used on same dimensions")}return this}),i("cube",function(e){if(this.length>3)throw Error("shape cannot have more than 3 entries");const t=void 0===this[0]?1:r.nonNegInt(this[0]),i=void 0===this[1]?1:r.nonNegInt(this[1]),o=void 0===this[2]?1:r.nonNegInt(this[2]),l=new Array(t*i*o);k(l),l._s[0]=t,l._s[1]=i,l._s[2]=o;var[e,a]=u(e);return void 0!==e&&(a?n:s)(l,e),l}),i("rand",function(e){e=r.single(e);const t=this.cube(),n=t.length;if(void 0!==e){const s=r.posInt(e)+1;for(let e=0;e<n;e++)t[e]=Math.floor(Math.random()*s)}else for(let e=0;e<n;e++)t[e]=Math.random();return t}),i("normal",function(e,t){const n=()=>{let e,t,r;for(;;)if((r=(e=2*Math.random()-1)*e+(t=2*Math.random()-1)*t)>0&&r<1)return e*Math.sqrt(-2*Math.log(r)/r)};if(e=r.number(f(r.single(e),0)),(t=r.number(f(r.single(t),1)))<=0)throw Error("positive number expected (standard deviation)");const s=this.cube(),i=s.length;for(let r=0;r<i;r++)s[r]=n()*t+e;return s}),i("shape",function(){return this._data_cube||k(this),_(this._s)}),i("$shape",function(e){this._data_cube||k(this),r.argRange(arguments,0,1);var[e,t]=u(e);let n=1,s=1,i=1;const o=0===this.length;if(void 0===e)n=this.length;else if(t)if(0===(n=r.nonNegInt(e))){if(!o)throw Error("number of entries cannot change")}else s=o?0:r.nonNegInt(this.length/n);else if(2===e.length)if((n=r.nonNegInt(e[0]))*(s=r.nonNegInt(e[1]))==0){if(!o)throw Error("number of entries cannot change")}else i=o?0:r.nonNegInt(this.length/(n*s));else{if(3!==e.length)throw Error("shape must have 1-3 entries");if((n=r.nonNegInt(e[0]))*(s=r.nonNegInt(e[1]))*(i=r.nonNegInt(e[2]))!==this.length)throw Error("number of entries cannot change")}return this._s[0]=n,this._s[1]=s,this._s[2]=i,this._k&&delete this._k,this._l&&delete this._l,this}),i("n",function(e){return this._data_cube||k(this),e=r.dim(e),this._s[e]}),i("label",function(e){if(this._data_cube||k(this),e=r.dim(e),this._l)return this._l[e]}),i("$label",function(e,t){if(this._data_cube||k(this),1===r.argRange(arguments,1,2)&&([e,t]=[void 0,e]),e=r.dim(e),""===(t=""+r.single(t)))throw Error("label cannot be empty string");return y(this),this._l[e]=t,this}),i("key",function(e){if(this._data_cube||k(this),e=r.dim(e),this._k){const t=this._k[e];if(t)return[...t.keys()]}}),i("$key",function(e,t){this._data_cube||k(this),1===r.argRange(arguments,1,2)&&([e,t]=[void 0,e]),e=r.dim(e);const n=a(c(t));if(this._s[e]!==n.size)throw Error("shape mismatch");return g(this),this._k[e]=n,this}),i("copy",function(e){if("full"!==(e=f(r.single(e),"full"))&&"core"!==e&&"shell"!==e&&"array"!==e)throw Error("'full', 'core', 'shell' or 'array' expected");if("array"===e)return _(this);const t="shell"===e?new Array(this.length):_(this);if(k(t),this._data_cube&&(t._s[0]=this._s[0],t._s[1]=this._s[1],t._s[2]=this._s[2],"core"!==e&&(this._l&&(y(t),t._l[0]=this._l[0],t._l[1]=this._l[1],t._l[2]=this._l[2]),this._k))){g(t);for(let e=0;e<3;e++)this._k[e]&&(t._k[e]=d(this._k[e]))}return t}),i("hasKey",function(e,t){this._data_cube||k(this),e=r.dim(e),t=r.single(t);const n=this._k,s=!(!n||!n[e]);return void 0===t?s:s&&n[e].has(t)});{const e=(e,t,r)=>{if(void 0===r||null===r){if(0===e._s[t])throw Error("empty dimension");return 0}return e._k&&e._k[t]?p(e._k[t].get(r),e._s[t]):p(r,e._s[t])};i("at",function(t,n,s){this._data_cube||k(this);const i=arguments.length;if(1===i)return this[e(this,0,r.single(t))];if(2===i)return this[e(this,0,r.single(t))+e(this,1,r.single(n))*this._s[0]];if(i>3){const i=this._s;return this[e(this,0,r.single(t))+e(this,1,r.single(n))*i[0]+e(this,2,r.single(s))*i[0]*i[1]]}throw Error("too few arguments")}),i("$at",function(t,n,s,i){this._data_cube||k(this);const o=r.argRange(arguments,2,4);if(i=r.single(i),2===o)this[e(this,0,r.single(t))]=n;else if(3===o)this[e(this,0,r.single(t))+e(this,1,r.single(n))*this._s[0]]=s;else{const o=this._s;this[e(this,0,r.single(t))+e(this,1,r.single(n))*o[0]+e(this,2,r.single(s))*o[0]*o[1]]=i}return this})}i("vec",function(e){this._data_cube||k(this);var[e,t]=u(e);const r=this.length;if(t)return[this[p(e,r)]];const n=new Array(r);for(let t=0;t<r;t++)n[t]=this[p(e[t],r)];return n}),i("$vec",function(e,t){this._data_cube||k(this);r.argRange(arguments,2,2);var[e,n]=u(t),[t,s]=u(t);const i=this.length;if(n){if(!s)throw Error("shape mismatch");this[p(e,i)]=t}else{const r=new Array(i);for(let t=0;t<i;t++)r[t]=p(e[t],i);if(s)for(let e=0;e<i;e++)this[r[e]]=t;else{if(t.length!==i)throw Error("shape mismatch");for(let e=0;e<i;e++)this[r[e]]=t[e]}}return this});{const{rangeInd:e,keyInd:n,indInd:s}=t,o=(t,r,i)=>{const o=t._s[r];return 1!==(i=c(i)).length||void 0!==i[0]&&null!==i[0]?t._k&&t._k[r]?[n(i,t._k[r]),!1]:[s(i,o),!1]:[0===o?[]:e(0,o-1),!0]};i("sc",function(e,t,n,s){if(this._data_cube||k(this),"full"!==(s=f(r.single(s),"full"))&&"core"!==s&&"array"!==s)throw Error("'full', 'core', or 'array' expected");const[i,l]=this._s,h=[o(this,0,e),o(this,1,t),o(this,2,n)],u=h[0][0],_=h[1][0],y=h[2][0],p=u.length,m=_.length,w=y.length,A=new Array(p*m*w);let v=0;for(let e=0;e<w;e++){let t=i*l*y[e];for(let e=0;e<m;e++){let r=i*_[e];for(let e=0;e<p;e++)A[v++]=this[u[e]+r+t]}}if("array"===s)return A;if(k(A),A._s[0]=p,A._s[1]=m,A._s[2]=w,"core"===s)return A;if(this._k){g(A);for(let e=0;e<3;e++)this._k[e]&&(A._k[e]=h[e][1]?d(this._k[e]):a(c(arguments[e])))}return b(this,A),A}),i("$sc",function(e,t,n,s){switch(this._data_cube||k(this),r.argRange(arguments,1,4)){case 1:[e,t,n,s]=[,,,e];break;case 2:[e,t,n,s]=[e,,,t];break;case 3:[e,t,n,s]=[e,t,,n]}const[i,l]=this._s,a=o(this,0,e)[0],h=o(this,1,t)[0],f=o(this,2,n)[0],c=a.length,_=h.length,d=f.length;var[s,g]=u(s);if(!g&&s.length!==c*_*d)throw Error("shape mismatch");let y=0;for(let e=0;e<d;e++){let t=i*l*f[e];for(let e=0;e<_;e++){let r=i*h[e];for(let e=0;e<c;e++)this[a[e]+r+t]=g?s:s[y++]}}return this}),i("row",function(e,t){return this.sc(e,null,null,t)}),i("col",function(e,t){return this.sc(null,e,null,t)}),i("page",function(e,t){return this.sc(null,null,e,t)}),i("$row",function(e,t){return 1===r.argRange(arguments,1,2)?this.$sc(e):this.$sc(e,null,null,t)}),i("$col",function(e,t){return 1===r.argRange(arguments,1,2)?this.$sc(e):this.$sc(null,e,null,t)}),i("$page",function(e,t){return 1===r.argRange(arguments,1,2)?this.$sc(e):this.$sc(null,null,e,t)});const l=function(n,s,i,o,l,a){let h,u;if(s._data_cube||k(s),n){switch(r.argRange(arguments,4,6)){case 4:[o,l,a]=[null,null,o];break;case 5:[o,l,a]=[o,null,l]}h="$sc"}else h="sc";if(o=r.single(o),l=r.single(l),s._k&&s._k[i])u=t.rangeKey(o,l,s._k[i]);else{const t=s._s[i];o=null===o||void 0===o?0:p(o,t),l=null===l||void 0===l?t-1:p(l,t),u=0===t?[]:e(o,l)}switch(i){case 0:return s[h](u,null,null,a);case 1:return s[h](null,u,null,a);case 2:return s[h](null,null,u,a)}};["down","along","back","$down","$along","$back"].forEach((e,t)=>{i(e,function(e,r,n){return l(t>2,this,t%3,...arguments)})}),i("head",function(n,s,i,o){this._data_cube||k(this);const l=new Array(3);for(let n=0;n<3;n++){let s=r.single(arguments[n]);const i=this._s[n];null===s||void 0===s?s=i:(r.nonNegInt(s),s=Math.min(s,i)),0===s?l[n]=[]:this._k&&this._k[n]?l[n]=t.firstKey(s,this._k[n]):l[n]=e(0,s-1)}return this.sc(...l,o)})}{const e=(e,t,r,n,s,i)=>{const[o,l,a]=n._s,h=o*l;let u,f=0;if(0===t){u=new Array(l*a);for(let t=0;t<a;t++)for(let r=0;r<l;r++)u[f++]=e[s+o*r+h*t]}else if(1===t){u=new Array(o*a);for(let t=0;t<a;t++)for(let r=0;r<o;r++)u[f++]=e[r+o*s+h*t]}else{u=new Array(o*l);for(let t=0;t<l;t++)for(let r=0;r<o;r++)u[f++]=e[r+o*t+h*s]}if("array"===r)return u;if(k(u),u._s[0]=o,u._s[1]=l,u._s[2]=a,u._s[t]=1,"core"===r)return u;if(m(n,u,t),void 0!==i){g(u);const e=new Map;e.set(i,0),u._k[t]=e}return b(n,u),u},t=(t,n,s)=>{t._data_cube||k(t),s=f(r.single(s),"none");const i=t._k&&t._k[n],o=t._s[n];if("none"===s)return i?function*(){for(let e of t._k[n].keys())yield e}():function*(){for(let e=0;e<o;e++)yield e}();{const r=w(t,n);if("full"!==s&&"core"!==s&&"array"!==s)throw Error("'none', 'full', 'core', or 'array' expected");return i?function*(){for(let[i,o]of t._k[n].entries())yield[i,e(t,n,s,r,o,i)]}():function*(){for(let i=0;i<o;i++)yield[i,e(t,n,s,r,i)]}()}};["rows","cols","pages"].forEach((e,r)=>{i(e,function(e){return t(this,r,e)})})}i("vble",function(e){this._data_cube||k(this),e=f(r.single(e),0);const n=["r_","c_","p_"],{_s:s,_k:i,_l:o}=this,[l,a,h]=s,[u,c,_]=[0,1,2].map(e=>i&&i[e]?[...i[e].keys()]:t.simpleRange(s[e]).map(t=>n[e]+t)),[d,g,y]=[0,1,2].map(e=>o&&o[e]||t.shortDimName[e]);let p;if(-1===e){p=new Array(this.length);let e=0;for(let t=0;t<h;t++){let r=l*a*t;for(let n=0;n<a;n++){let s=l*n;for(let i=0;i<l;i++)p[e++]={[d]:u[i],[g]:c[n],[y]:_[t],entry:this[i+s+r]}}}}else if(0===e){p=new Array(a*h);let e=0,t=0;for(let r=0;r<h;r++)for(let n=0;n<a;n++){let s={};s[g]=c[n],s[y]=_[r];for(let e=0;e<l;e++)s[u[e]]=this[t++];p[e++]=s}}else if(1===e){p=new Array(l*h);let e=0;for(let t=0;t<h;t++)for(let r=0;r<l;r++){let n=r+t*l*a,s={};s[d]=u[r],s[y]=_[t];for(let e=0;e<a;e++)s[c[e]]=this[n+e*l];p[e++]=s}}else{if(2!==e)throw Error("invalid dimension");{const e=l*a;p=new Array(e);let t=0,r=-1;for(let n=0;n<a;n++)for(let s=0;s<l;s++){r++;let i={};i[d]=u[s],i[g]=c[n];for(let t=0;t<h;t++)i[_[t]]=this[r+t*e];p[t++]=i}}}return p});{const e=["isInteger","isFinite","isNaN"],t=(e,t)=>{t.forEach(t=>{i(t,function(){this._data_cube||k(this);const r=this.copy("shell"),n=this.length,s=e[t];for(let e=0;e<n;e++)r[e]=s(this[e]);return r})})};t(Math,["sqrt","cbrt","abs","round","floor","ceil","exp","log","sin","cos","tan","asin","acos","atan","sinh","cosh","tanh","asinh","acosh","atanh"]),t(Number,e);const r=[["neg",(e,t)=>-e],["log10",(e,t)=>Math.log(e)/Math.LN10],["log2",(e,t)=>Math.log(e)/Math.LN2],["num",(e,t)=>+e],["string",(e,t)=>""+e],["boolean",(e,t)=>!!e],["date",(e,t)=>new Date(e)],["not",(e,t)=>!e],["typeof",(e,t)=>typeof e],["trim",(e,t)=>e.trim()],["toLowerCase",(e,t)=>e.toLowerCase()],["toUpperCase",(e,t)=>e.toUpperCase()]];for(let[e,t]of r)i(e,function(){this._data_cube||k(this);const e=this.copy("shell"),r=this.length;for(let n=0;n<r;n++)e[n]=t(this[n]);return e})}{const e=[["add",(e,t)=>e+t],["sub",(e,t)=>e-t],["mul",(e,t)=>e*t],["div",(e,t)=>e/t],["rem",(e,t)=>e%t],["pow",Math.pow],["eq",(e,t)=>e===t],["neq",(e,t)=>e!==t],["lt",(e,t)=>e<t],["lte",(e,t)=>e<=t],["gt",(e,t)=>e>t],["gte",(e,t)=>e>=t],["lof",(e,t)=>Math.min],["gof",(e,t)=>Math.max],["toExponential",(e,t)=>e.toExponential(t)],["toFixed",(e,t)=>e.toFixed(t)],["toPrecision",(e,t)=>e.toPrecision(t)],["charAt",(e,t)=>e.charAt(t)],["repeat",(e,t)=>e.repeat(t)],["search",(e,t)=>e.search(t)],["test",(e,t)=>e.test(t)],["and",(e,t)=>e&&t],["or",(e,t)=>e||t]];for(let[t,r]of e)i(t,function(e){this._data_cube||k(this);var[e,t]=u(e);const n=this.length;let s;if(t){s=this.copy("shell");for(let t=0;t<n;t++)s[t]=r(this[t],e)}else{const t=e.length;if(1===n){s=e.copy("core");const n=this[0];for(let i=0;i<t;i++)s[i]=r(n,e[i])}else{if(s=this.copy("shell"),n!==t)throw Error("shape mismatch");for(let t=0;t<n;t++)s[t]=r(this[t],e[t])}}return s})}}return{}});
