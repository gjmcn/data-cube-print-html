!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t._data_cube=e()}(this,function(){"use strict";var t;"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;{const e=(function(t,e){var r;t.exports=(function(t){{const e={dimName:["row","column","page"],shortDimName:["row","col","page"],lettersArray:["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"],copyArray:t=>{const e=t.length,r=new Array(e);for(let n=0;n<e;n++)r[n]=t[n];return r},equalArray:(t,e)=>{var r=t.length;if(r!==e.length)return!1;for(var n=0;n<r;n++)if(t[n]!==e[n])return!1;return!0},equalArrayOfArray:(t,r)=>{if(!Array.isArray(t)||!Array.isArray(r))return!1;const n=t.length;if(n!==r.length)return!1;for(let s=0;s<n;s++){if(!Array.isArray(t[s])||!Array.isArray(r[s]))return!1;if(!e.equalArray(t[s],r[s]))return!1}return!0},copyMap:t=>{const e=new Map;for(let[r,n]of t.entries())e.set(r,n);return e},equalMap:(t,e)=>{if(t.size!==e.size)return!1;const r=e.entries();for(let[e,n]of t.entries()){let[t,s]=r.next().value;if(e!==t||n!==s)return!1}return!0},toMap:(...t)=>{const e=t.length;if(e%2!=0)throw Error("even number of arguments expected");const r=new Map;for(let n=0;n<e;n+=2)r.set(t[n],t[n+1]);if(r.size!==e/2)throw Error("duplicate key");return r},keyMap:t=>{const e=t.length,r=new Map;for(let n=0;n<e;n++){let e=t[n];if(void 0===e||null===e)throw Error(`invalid key: ${e}`);r.set(e,n)}if(r.size!==e)throw Error("duplicate key");return r},simpleRange:t=>{t=r.nonNegInt(t);for(var e=new Array(t),n=0;n<t;n++)e[n]=n;return e},shuffle:t=>{t=r.posInt(t);var e,n=new Array(t);n[0]=0;for(var s=1;s<t;s++)e=Math.floor(Math.random()*(s+1)),n[s]=n[e],n[e]=s;return n},fill:(t,e)=>{const r=t.length;for(let n=0;n<r;n++)t[n]=e;return t},fillEW:(t,e)=>{const r=t.length;if(e.length!==r)throw Error("shape mismatch");for(let n=0;n<r;n++)t[n]=e[n];return t},isSingle:t=>!Array.isArray(t)||1===t.length,toArray:t=>Array.isArray(t)?t:[t],polarize:t=>Array.isArray(t)?1===t.length?[t[0],!0]:[t,!1]:[t,!0],def:(t,e)=>void 0===t?e:t,addArrayMethod:(t,e)=>{if(t in Array.prototype)throw Error(t+" is already a property of Array.protoype");Object.defineProperty(Array.prototype,t,{value:e,configurable:!0,enumerable:!1,writable:!0})},ensure:(t,e)=>{t[e]||Object.defineProperty(t,e,{value:new Array(3),configurable:!0,writable:!0})},ensureKey:t=>{e.ensure(t,"_k")},ensureLabel:t=>{e.ensure(t,"_l")},copyKey:(t,r,n)=>{if(t._k)for(let s=0;s<3;s++)s!==n&&t._k[s]&&(e.ensureKey(r),r._k[s]=e.copyMap(t._k[s]))},copyLabel:(t,r,n)=>{if(t._l)for(let s=0;s<3;s++)s!==n&&t._l[s]&&(e.ensureLabel(r),r._l[s]=t._l[s])},skeleton:(t,r,n)=>{const s=[];return s._s=e.copyArray(t._s),e.copyKey(t,s,r),e.copyLabel(t,s,n),s},nni:(t,e)=>{if(!Number.isInteger(t))throw Error("integer expected");if(t>=e||t<-e)throw Error("index out of bounds");return t<0?t+e:t},rangeKey:(t,e,r)=>{const n=new Array(r.size);let s=null===t||void 0===t?1:0;const i=null!==e&&void 0!==e;let o=0;for(let l of r.keys())if(s){if(n[o++]=l,i&&l===e){s=2;break}}else if(l===t){if(n[o++]=l,i&&t===e){s=2;break}s=1}if(0===s)throw Error("start key does not exist");if(i&&1===s)throw Error("end-key does not exist or is before start-key");return n.length=o,n},firstKey:(t,e)=>{const r=new Array(t);let n=0;for(let s of e.keys()){if(n===t)break;r[n++]=s}return r.length=n,r},rangeInd:(t,e)=>{if(e<t)throw Error("end less than start");const r=new Array(e-t+1);let n=0;for(let s=t;s<=e;s++)r[n++]=s;return r},indInd:(t,r)=>{const n=t.length,s=new Array(n);for(let i=0;i<n;i++)s[i]=e.nni(t[i],r);return s},keyInd:(t,e)=>{const r=t.length,n=new Array(r);for(let s=0;s<r;s++){let r=e.get(t[s]);if(void 0===r)throw Error("key does not exist");n[s]=r}return n},timer:t=>{const e=process.hrtime();t();const r=process.hrtime(e);return Math.round((1e9*r[0]+r[1])/1e6)}};{const t=e.lettersArray,r=new Map;for(let e=0;e<t.length;e++)r.set(t[e],e);e.lettersMap=r}const r={nonNegInt:t=>{if(!Number.isInteger(t)||t<0)throw Error("non-negative integer expected");return t},posInt:t=>{if(!Number.isInteger(t)||t<=0)throw Error("positive integer expected");return t},number:t=>{if("number"!=typeof t)throw Error("number expected");return t},dim:t=>{if(void 0===(t=r.single(t)))return 0;if(0!==t&&1!==t&&2!==t)throw Error("invalid dimension");return t},single:t=>{if(Array.isArray(t)){if(1!==t.length)throw Error("singleton expected");return t[0]}return t},func:t=>{if("function"!=typeof t)throw Error("function expected");return t},argRange:(t,e,r)=>{const n=t.length;if(n<e)throw Error("too few arguments");if(n>r)throw Error("too many arguments");return n},dataMatrix:t=>{if(1!==t._s[2]||0===t._s[1])throw Error("matrix with at least 1 column expected")}};e.assert=r,t.exports=e}}(r={exports:{}}),r.exports)}(t={exports:{}},t.exports),t.exports),{assert:r,fill:n,fillEW:s,addArrayMethod:i,keyMap:o,isSingle:l,polarize:h,def:a,toArray:f,copyArray:u,copyMap:c,ensureKey:g,ensureLabel:d,nni:_,copyKey:y,copyLabel:p,skeleton:m}=e;["_data_cube","_s","_k","_l"].forEach(t=>{if(t in Array.prototype)throw Error(t+" is a property of Array.protoype")});{const t={};["copyWithin","fill","pop","push","reverse","shift","sort","splice","unshift"].forEach(e=>{t[e]=Array.prototype[e],delete Array.prototype[e],i(e,function(){if(this._data_cube)throw Error(`native array method ${e} cannot be used with cubes`);return t[e].apply(this,arguments)})})}const b=t=>{Object.defineProperty(t,"length",{writable:!1}),Object.defineProperty(t,"_data_cube",{value:!0}),Object.defineProperty(t,"_s",{value:[t.length,1,1],writable:!0})};i("toCube",function(){return this._data_cube||b(this),this}),i("compare",function(t,n){if(this._data_cube||b(this),n=a(r.single(n),!0),this===t)return this;let s;if(s=n?t=>{throw Error(t)}:()=>!1,!Array.isArray(t))return s("cube compared to non-array");const i=this.length;if(i!==t.length)return s("number of entries not equal");for(let e=0;e<i;e++)if(this[e]!==t[e])return s(`entries at vector index ${e} not equal`);if(t._data_cube){if(!e.equalArray(this._s,t._s))return s("shape not equal");const r=this._k,n=t._k;if(r){if(!n)return s("keys-indices");for(let t=0;t<3;t++)if(r[t]){if(!n[t])return s(`keys-indices, ${e.dimName[t]}s`);if(!e.equalMap(r[t],n[t]))return s(`${e.dimName[t]} keys not equal`)}else if(n[t])return s("indices-keys")}else if(n)return s("indices-keys");const i=this._l,o=t._l;if(i){if(!o)return s("labels not equal or not used on same dimensions");if(!e.equalArray(i,o))return s("labels not equal or not used on same dimensions")}else if(o)return s("labels not equal or not used on same dimensions")}else{if(1!==this._s[1]||1!==this._s[2])return s("shape not equal");if(this._k)return s("keys-indices");if(this._l)return s("labels not equal or not used on same dimensions")}return this}),i("cube",function(t){if(this.length>3)throw Error("shape cannot have more than 3 entries");const e=void 0===this[0]?1:r.nonNegInt(this[0]),i=void 0===this[1]?1:r.nonNegInt(this[1]),o=void 0===this[2]?1:r.nonNegInt(this[2]),l=new Array(e*i*o);b(l),l._s[0]=e,l._s[1]=i,l._s[2]=o;var[t,a]=h(t);return void 0!==t&&(a?n:s)(l,t),l}),i("rand",function(t){t=r.single(t);const e=this.cube(),n=e.length;if(void 0!==t){const s=r.posInt(t)+1;for(let t=0;t<n;t++)e[t]=Math.floor(Math.random()*s)}else for(let t=0;t<n;t++)e[t]=Math.random();return e}),i("normal",function(t,e){const n=()=>{let t,e,r;for(;;)if((r=(t=2*Math.random()-1)*t+(e=2*Math.random()-1)*e)>0&&r<1)return t*Math.sqrt(-2*Math.log(r)/r)};if(t=r.number(a(r.single(t),0)),(e=r.number(a(r.single(e),1)))<=0)throw Error("positive number expected (standard deviation)");const s=this.cube(),i=s.length;for(let r=0;r<i;r++)s[r]=n()*e+t;return s}),i("shape",function(){return this._data_cube||b(this),u(this._s)}),i("$shape",function(t){this._data_cube||b(this),r.argRange(arguments,0,1);var[t,e]=h(t);let n=1,s=1,i=1;const o=0===this.length;if(void 0===t)n=this.length;else if(e)if(0===(n=r.nonNegInt(t))){if(!o)throw Error("number of entries cannot change")}else s=o?0:r.nonNegInt(this.length/n);else if(2===t.length)if((n=r.nonNegInt(t[0]))*(s=r.nonNegInt(t[1]))==0){if(!o)throw Error("number of entries cannot change")}else i=o?0:r.nonNegInt(this.length/(n*s));else{if(3!==t.length)throw Error("shape must have 1-3 entries");if((n=r.nonNegInt(t[0]))*(s=r.nonNegInt(t[1]))*(i=r.nonNegInt(t[2]))!==this.length)throw Error("number of entries cannot change")}return this._s[0]=n,this._s[1]=s,this._s[2]=i,this._k&&delete this._k,this._l&&delete this._l,this}),i("n",function(t){return this._data_cube||b(this),t=r.dim(t),this._s[t]}),i("label",function(t){return this._data_cube||b(this),t=r.dim(t),this._l&&this._l[t]||null}),i("$label",function(t,e){if(this._data_cube||b(this),1===r.argRange(arguments,1,2)&&([t,e]=[void 0,t]),t=r.dim(t),null===(e=r.single(e))){const e=this._l;e&&e[t]&&(e[t]=void 0,e[0]||e[1]||e[2]||delete this._l)}else{if(""===(e=""+e))throw Error("label cannot be empty string");d(this),this._l[t]=e}return this}),i("key",function(t){if(this._data_cube||b(this),t=r.dim(t),this._k){const e=this._k[t];if(e)return[...e.keys()]}return null}),i("$key",function(t,e){if(this._data_cube||b(this),1===r.argRange(arguments,1,2)&&([t,e]=[void 0,t]),t=r.dim(t),1===(e=f(e)).length&&null===e[0]){const e=this._k;e&&e[t]&&(e[t]=void 0,e[0]||e[1]||e[2]||delete this._k)}else{const r=o(e);if(this._s[t]!==r.size)throw Error("shape mismatch");g(this),this._k[t]=r}return this}),i("$strip",function(){return this._data_cube||b(this),r.argRange(arguments,0,0),delete this._k,delete this._l,this}),i("copy",function(t){if("full"!==(t=a(r.single(t),"full"))&&"core"!==t&&"shell"!==t&&"array"!==t)throw Error("'full', 'core', 'shell' or 'array' expected");if("array"===t)return u(this);const e="shell"===t?new Array(this.length):u(this);if(b(e),this._data_cube&&(e._s[0]=this._s[0],e._s[1]=this._s[1],e._s[2]=this._s[2],"core"!==t&&(this._l&&(d(e),e._l[0]=this._l[0],e._l[1]=this._l[1],e._l[2]=this._l[2]),this._k))){g(e);for(let t=0;t<3;t++)this._k[t]&&(e._k[t]=c(this._k[t]))}return e}),i("hasKey",function(t,e){this._data_cube||b(this),t=r.dim(t),e=r.single(e);const n=this._k,s=!(!n||!n[t]);return void 0===e?s:s&&n[t].has(e)});{const t=(t,e,n)=>void 0===n||null===n?0:t._k&&t._k[e]?r.number(t._k[e].get(n)):_(n,t._s[e]);i("at",function(e,n,s){if(this._data_cube||b(this),0===this.length)throw Error("cube has no entries");const i=arguments.length;if(i<=1)return this[t(this,0,r.single(e))];if(2===i)return this[t(this,0,r.single(e))+t(this,1,r.single(n))*this._s[0]];{const i=this._s;return this[t(this,0,r.single(e))+t(this,1,r.single(n))*i[0]+t(this,2,r.single(s))*i[0]*i[1]]}}),i("$at",function(e,n,s,i){if(this._data_cube||b(this),0===this.length)throw Error("cube has no entries");const o=r.argRange(arguments,1,4);if(2===o)this[t(this,0,r.single(e))]=r.single(n);else if(3===o)this[t(this,0,r.single(e))+t(this,1,r.single(n))*this._s[0]]=r.single(s);else if(4===o){const o=this._s;this[t(this,0,r.single(e))+t(this,1,r.single(n))*o[0]+t(this,2,r.single(s))*o[0]*o[1]]=r.single(i)}else this[0]=r.single(e);return this})}i("vec",function(t){this._data_cube||b(this);var[t,e]=h(t);const r=this.length;if(e)return void 0===t||null===t?u(this):[this[_(t,r)]];const n=t.length,s=new Array(n);for(let e=0;e<n;e++)s[e]=this[_(t[e],r)];return s}),i("$vec",function(t,e){this._data_cube||b(this);r.argRange(arguments,1,2);1===arguments.length&&([t,e]=[null,t]);const i=this.length;var[t,o]=h(t),[e,l]=h(e);if(o)if(void 0===t||null===t)(l?n:s)(this,e);else{if(!l)throw Error("shape mismatch");this[_(t,i)]=e}else{const r=t.length,n=new Array(r);for(let e=0;e<r;e++)n[e]=_(t[e],i);if(l)for(let t=0;t<r;t++)this[n[t]]=e;else{if(e.length!==r)throw Error("shape mismatch");for(let t=0;t<r;t++)this[n[t]]=e[t]}}return this});{const{rangeInd:t,keyInd:n,indInd:s}=e,l=(e,r,i)=>{const o=e._s[r];return 1!==(i=f(i)).length||void 0!==i[0]&&null!==i[0]?e._k&&e._k[r]?[n(i,e._k[r]),!1]:[s(i,o),!1]:[0===o?[]:t(0,o-1),!0]};i("sc",function(t,e,n,s){if(this._data_cube||b(this),"full"!==(s=a(r.single(s),"full"))&&"core"!==s&&"array"!==s)throw Error("'full', 'core', or 'array' expected");const[i,h]=this._s,u=[l(this,0,t),l(this,1,e),l(this,2,n)],d=u[0][0],_=u[1][0],y=u[2][0],m=d.length,w=_.length,k=y.length,v=new Array(m*w*k);let A=0;for(let t=0;t<k;t++){let e=i*h*y[t];for(let t=0;t<w;t++){let r=i*_[t];for(let t=0;t<m;t++)v[A++]=this[d[t]+r+e]}}if("array"===s)return v;if(b(v),v._s[0]=m,v._s[1]=w,v._s[2]=k,"core"===s)return v;if(this._k){g(v);for(let t=0;t<3;t++)this._k[t]&&(v._k[t]=u[t][1]?c(this._k[t]):o(f(arguments[t])))}return p(this,v),v}),i("$sc",function(t,e,n,s){switch(this._data_cube||b(this),r.argRange(arguments,1,4)){case 1:[t,e,n,s]=[,,,t];break;case 2:[t,e,n,s]=[t,,,e];break;case 3:[t,e,n,s]=[t,e,,n]}const[i,o]=this._s,a=l(this,0,t)[0],f=l(this,1,e)[0],u=l(this,2,n)[0],c=a.length,g=f.length,d=u.length;var[s,_]=h(s);if(!_&&s.length!==c*g*d)throw Error("shape mismatch");let y=0;for(let t=0;t<d;t++){let e=i*o*u[t];for(let t=0;t<g;t++){let r=i*f[t];for(let t=0;t<c;t++)this[a[t]+r+e]=_?s:s[y++]}}return this}),i("row",function(t,e){return this.sc(t,null,null,e)}),i("col",function(t,e){return this.sc(null,t,null,e)}),i("page",function(t,e){return this.sc(null,null,t,e)}),i("$row",function(t,e){return 1===r.argRange(arguments,1,2)?this.$sc(t):this.$sc(t,null,null,e)}),i("$col",function(t,e){return 1===r.argRange(arguments,1,2)?this.$sc(t):this.$sc(null,t,null,e)}),i("$page",function(t,e){return 1===r.argRange(arguments,1,2)?this.$sc(t):this.$sc(null,null,t,e)});const u=function(n,s,i,o,l,h){let a,f;if(s._data_cube||b(s),n){switch(r.argRange(arguments,4,6)){case 4:[o,l,h]=[null,null,o];break;case 5:[o,l,h]=[o,null,l]}a="$sc"}else a="sc";if(o=r.single(o),l=r.single(l),s._k&&s._k[i])f=e.rangeKey(o,l,s._k[i]);else{const e=s._s[i];o=null===o||void 0===o?0:_(o,e),l=null===l||void 0===l?e-1:_(l,e),f=0===e?[]:t(o,l)}switch(i){case 0:return s[a](f,null,null,h);case 1:return s[a](null,f,null,h);case 2:return s[a](null,null,f,h)}};["down","along","back","$down","$along","$back"].forEach((t,e)=>{i(t,function(t,r,n){return u(e>2,this,e%3,...arguments)})}),i("head",function(n,s,i,o){this._data_cube||b(this);const l=new Array(3);for(let n=0;n<3;n++){let s=r.single(arguments[n]);const i=this._s[n];null===s||void 0===s?s=i:(r.nonNegInt(s),s=Math.min(s,i)),0===s?l[n]=[]:this._k&&this._k[n]?l[n]=e.firstKey(s,this._k[n]):l[n]=t(0,s-1)}return this.sc(...l,o)})}{const t=(t,e,r,n,s,i)=>{const[o,l,h]=n._s,a=o*l;let f,u=0;if(0===e){f=new Array(l*h);for(let e=0;e<h;e++)for(let r=0;r<l;r++)f[u++]=t[s+o*r+a*e]}else if(1===e){f=new Array(o*h);for(let e=0;e<h;e++)for(let r=0;r<o;r++)f[u++]=t[r+o*s+a*e]}else{f=new Array(o*l);for(let e=0;e<l;e++)for(let r=0;r<o;r++)f[u++]=t[r+o*e+a*s]}if("array"===r)return f;if(b(f),f._s[0]=o,f._s[1]=l,f._s[2]=h,f._s[e]=1,"core"===r)return f;if(y(n,f,e),void 0!==i){g(f);const t=new Map;t.set(i,0),f._k[e]=t}return p(n,f),f},e=(e,n,s)=>{e._data_cube||b(e),s=a(r.single(s),"none");const i=e._k&&e._k[n],o=e._s[n];if("none"===s)return i?function*(){for(let t of e._k[n].keys())yield t}():function*(){for(let t=0;t<o;t++)yield t}();{const r=m(e,n);if("full"!==s&&"core"!==s&&"array"!==s)throw Error("'none', 'full', 'core', or 'array' expected");return i?function*(){for(let[i,o]of e._k[n].entries())yield[i,t(e,n,s,r,o,i)]}():function*(){for(let i=0;i<o;i++)yield[i,t(e,n,s,r,i)]}()}};["rows","cols","pages"].forEach((t,r)=>{i(t,function(t){return e(this,r,t)})})}i("vble",function(t){this._data_cube||b(this),t=a(r.single(t),0);const n=["r_","c_","p_"],{_s:s,_k:i,_l:o}=this,[l,h,f]=s,[u,c,g]=[0,1,2].map(t=>i&&i[t]?[...i[t].keys()]:e.simpleRange(s[t]).map(e=>n[t]+e)),[d,_,y]=[0,1,2].map(t=>o&&o[t]||e.shortDimName[t]);let p;if(-1===t){p=new Array(this.length);let t=0;for(let e=0;e<f;e++){let r=l*h*e;for(let n=0;n<h;n++){let s=l*n;for(let i=0;i<l;i++)p[t++]={[d]:u[i],[_]:c[n],[y]:g[e],entry:this[i+s+r]}}}}else if(0===t){p=new Array(h*f);let t=0,e=0;for(let r=0;r<f;r++)for(let n=0;n<h;n++){let s={};s[_]=c[n],s[y]=g[r];for(let t=0;t<l;t++)s[u[t]]=this[e++];p[t++]=s}}else if(1===t){p=new Array(l*f);let t=0;for(let e=0;e<f;e++)for(let r=0;r<l;r++){let n=r+e*l*h,s={};s[d]=u[r],s[y]=g[e];for(let t=0;t<h;t++)s[c[t]]=this[n+t*l];p[t++]=s}}else{if(2!==t)throw Error("invalid dimension");{const t=l*h;p=new Array(t);let e=0,r=-1;for(let n=0;n<h;n++)for(let s=0;s<l;s++){r++;let i={};i[d]=u[s],i[_]=c[n];for(let e=0;e<f;e++)i[g[e]]=this[r+e*t];p[e++]=i}}}return p});{const t=["isInteger","isFinite","isNaN"],e=(t,e)=>{e.forEach(e=>{i(e,function(){this._data_cube||b(this);const r=this.copy("shell"),n=this.length,s=t[e];for(let t=0;t<n;t++)r[t]=s(this[t]);return r})})};e(Math,["sqrt","cbrt","abs","round","floor","ceil","trunc","sign","exp","expm1","log","log10","log2","log1p","sin","cos","tan","asin","acos","atan","sinh","cosh","tanh","asinh","acosh","atanh"]),e(Number,t);const r=[["neg",t=>-t],["number",t=>+t],["string",t=>""+t],["boolean",t=>!!t],["date",t=>new Date(t)],["not",t=>!t],["typeof",t=>typeof t],["trim",t=>t.trim()],["toLowerCase",t=>t.toLowerCase()],["toUpperCase",t=>t.toUpperCase()]];for(let[t,e]of r)i(t,function(){this._data_cube||b(this);const t=this.copy("shell"),r=this.length;for(let n=0;n<r;n++)t[n]=e(this[n]);return t})}{const t=[["add",(t,e)=>t+e],["sub",(t,e)=>t-e],["mul",(t,e)=>t*e],["div",(t,e)=>t/e],["rem",(t,e)=>t%e],["pow",Math.pow],["atan2",Math.atan2],["hypot",Math.hypot],["eq",(t,e)=>t===e],["neq",(t,e)=>t!==e],["lt",(t,e)=>t<e],["lte",(t,e)=>t<=e],["gt",(t,e)=>t>e],["gte",(t,e)=>t>=e],["lof",(t,e)=>Math.min],["gof",(t,e)=>Math.max],["toExponential",(t,e)=>t.toExponential(e)],["toFixed",(t,e)=>t.toFixed(e)],["toPrecision",(t,e)=>t.toPrecision(e)],["charAt",(t,e)=>t.charAt(e)],["repeat",(t,e)=>t.repeat(e)],["search",(t,e)=>t.search(e)],["test",(t,e)=>t.test(e)],["and",(t,e)=>t&&e],["or",(t,e)=>t||e]];for(let[e,r]of t)i(e,function(t){this._data_cube||b(this);const n=arguments.length;if(n>1){let r=this[e](t);for(let t=1;t<n;t++)r=r[e](arguments[t]);return r}var[t,s]=h(t);const i=this.length;let o;if(s){o=this.copy("shell");for(let e=0;e<i;e++)o[e]=r(this[e],t)}else{const e=t.length;if(1===i){o=t.copy("shell");const n=this[0];for(let s=0;s<e;s++)o[s]=r(n,t[s])}else{if(i!==e)throw Error("shape mismatch");o=this.copy("shell");for(let e=0;e<i;e++)o[e]=r(this[e],t[e])}}return o})}i("method",function(t,...e){this._data_cube||b(this);const r=this.copy("shell"),n=this.length;var[t,s]=h(t);if(!s&&t.length!==n)throw Error("shape mismatch");const i=s?()=>t:e=>t[e],o=e.length;if(0===o){for(let t=0;t<n;t++)r[t]=this[t][i(t)]();return r}const l=new Array(o);for(let t=0;t<o;t++){let[r,s]=h(e[t]);if(s)l[t]=(()=>r);else{if(r.length!==n)throw Error("shape mismatch");l[t]=(t=>r[t])}}const a=t=>{const e=new Array(o);for(let r=0;r<o;r++)e[r]=l[r](t);return e};for(let t=0;t<n;t++)r[t]=this[t][i(t)](...a(t));return r});{const t=(t,e,r)=>{"prop"!==e||t._data_cube||b(t);const n=t.length;var[r,s]=h(r);if(!s&&r.length!==n)throw Error("shape mismatch");const i="prop"===e?t.copy("shell"):new Array(n),o=s?()=>r:t=>r[t];if("prop"===e)for(let e=0;e<n;e++)i[e]=t[e][o(e)];else if("style"===e)for(let e=0;e<n;e++)i[e]=window.getComputedStyle(t[e])[o(e)];else if("attr"===e)for(let e=0;e<n;e++)i[e]=t[e].getAttribute(o(e));else if("hasAttr"===e)for(let e=0;e<n;e++)i[e]=t[e].hasAttribute(o(e));else{if("hasClass"!==e)throw Error("invalid argument");for(let e=0;e<n;e++)i[e]=t[e].classList.contains(o(e))}return i};["prop","attr","style","hasAttr","hasClass"].forEach(e=>{i(e,function(r){return t(this,e,r)})});const e=(t,e,r)=>{"$prop"!==e||t._data_cube||b(t);const n=t.length,s=r.length;if(s<2||s%2!=0)throw Error("invalid number of arguments");const i=s/2,o=new Array(i),l=new Array(i);for(let e=0;e<i;e++){let[s,i]=h(r[2*e]),[a,f]=h(r[2*e+1]);if(!i&&s.length!==n)throw Error("shape mismatch");if(!f&&a.length!==n)throw Error("shape mismatch");o[e]=i?()=>s:t=>s[t],l[e]=f?"function"==typeof a?e=>a(t[e],e,t):()=>a:t=>a[t]}for(let r=0;r<i;r++){let s=o[r],i=l[r];if("$prop"===e)for(let e=0;e<n;e++)t[e][s(e)]=i(e);else if("$style"===e)for(let e=0;e<n;e++)t[e].style[s(e)]=i(e);else{if("$attr"!==e)throw Error("invalid argument");for(let e=0;e<n;e++)t[e].setAttribute(s(e),i(e))}}return t};["$prop","$attr","$style"].forEach(t=>{i(t,function(...r){return e(this,t,r)})})}i("cmap",function(t,e){this._data_cube||b(this);const n=this.map(r.single(t),r.single(e));return b(n),n._s[0]=this._s[0],n._s[1]=this._s[1],n._s[2]=this._s[2],y(this,n),p(this,n),n});{const t=(t,e,n,s,i)=>{t._data_cube||b(t),e=a(r.single(e),0),n=r.func(r.single(n)),s=r.single(s);const o=t.length;let l,h,f;if(void 0===s){if(!o)throw Error("must supply init if array/cube empty");l=1}else l=0;if(-1===e)if(h=l?t[0]:s,i){f=[o].cube(),l&&(f[0]=h);for(let e=l;e<o;e++)f[e]=h=n(h,t[e],e,t)}else{for(let e=l;e<o;e++)h=n(h,t[e],e,t);b(f=[h])}else{const[r,o,a]=t._s,u=r*o;if(i)f=t.copy("shell");else{if(0===e)f=[1,o,a].cube();else if(1===e)f=[r,1,a].cube();else{if(2!==e)throw Error("invalid dimension");f=[r,o,1].cube()}y(t,f,e),p(t,f,e)}if(0===e){let e=0;for(let c=0;c<a;c++){let a=u*c;for(let u=0;u<o;u++){let o=r*u;if(h=l?t[o+a]:s,i){l&&(f[o+a]=h);for(let e=l;e<r;e++){let r=e+o+a;f[r]=h=n(h,t[r],e,t)}}else{for(let e=l;e<r;e++)h=n(h,t[e+o+a],e,t);f[e++]=h}}}}else if(1===e){let e=0;for(let c=0;c<a;c++){let a=u*c;for(let u=0;u<r;u++)if(h=l?t[u+a]:s,i){l&&(f[u+a]=h);for(let e=l;e<o;e++){let s=u+e*r+a;f[s]=h=n(h,t[s],e,t)}}else{for(let e=l;e<o;e++)h=n(h,t[u+e*r+a],e,t);f[e++]=h}}}else{if(2!==e)throw Error("invalid dimension");{let e=0;for(let c=0;c<o;c++){let o=r*c;for(let c=0;c<r;c++)if(h=l?t[c+o]:s,i){l&&(f[c+o]=h);for(let e=l;e<a;e++)vInd=c+o+e*u,f[vInd]=h=n(h,t[vInd],e,t)}else{for(let e=l;e<a;e++)h=n(h,t[c+o+e*u],e,t);f[e++]=h}}}}}return f};i("fold",function(e,r,n){return t(this,e,r,n,!1)}),i("cumu",function(e,r,n){return t(this,e,r,n,!0)});const e=[["sum",(t,e)=>t+ +e,0],["prod",(t,e)=>t*e,1],["all",(t,e)=>t&&!!e,!0],["any",(t,e)=>t||!!e,!1],["count",(t,e)=>t+!!e,0],["min",(t,e)=>Math.min(t,e),1/0],["max",(t,e)=>Math.max(t,e),-1/0]];e.forEach(t=>{i(t[0],function(e){return this.fold(e,t[1],t[2])})}),e.forEach(t=>{i("cumu"+t[0][0].toUpperCase()+t[0].slice(1),function(e){return this.cumu(e,t[1],t[2])})}),i("range",function(t){const e=this.min(t),r=this.max(t),n=r.length;for(let t=0;t<n;t++)r[t]-=e[t];return r}),i("sameType",function(t){return this.fold(t,(t,e)=>((e=typeof e)===t||null===t)&&e,null)});const n=t=>t?(t,e,r)=>t[0]<e?[e,r]:t:(t,e,r)=>t[0]>e?[e,r]:t;["minPosn","maxPosn","cumuMinPosn","cumuMaxPosn"].forEach((t,e)=>{i(t,function(t){const s=e%2;let i=this[e>1?"cumu":"fold"](t,n(s),[[s?-1/0:1/0,null]]);const o=i.length;if(-1!==(t=a(r.single(t),0))&&this._k&&this._k[t]){const e=this.key(t);for(let t=0;t<o;t++){let r=i[t][1];i[t]=null===r?null:e[r]}}else for(let t=0;t<o;t++)i[t]=i[t][1];return i})}),["mean","geoMean"].forEach(t=>{i(t,function(e){const n="geoMean"===t,s=this[n?"prod":"sum"](e);if(-1===(e=a(r.single(e),0)))s[0]=n?Math.pow(s[0],1/this.length):s[0]/this.length;else{const t=s.length;let r=1/this._s[e];if(n)for(let e=0;e<t;e++)s[e]=Math.pow(s[e],r);else for(let e=0;e<t;e++)s[e]*=r}return s})}),i("sew",function(t,e){this._data_cube||b(this),e=a(r.single(e),",");const n=this.fold(t,(t,r)=>`${t}${e}${null===r||void 0===r?"":r}`,""),s=n.length,i=e.length;for(let t=0;t<s;t++)n[t]=n[t].slice(i);return n}),i("var",function(t,e){t=a(r.single(t),0),e=r.nonNegInt(a(r.single(e),0));const n=this.fold(t,(t,e)=>{const r=t[0]+1,n=e-t[1],s=t[1]+n/r;return[r,s,t[2]+n*(e-s)]},[[0,0,0]]),s=n.length;let i=(-1===t?this.length:this._s[t])-e;for(let t=0;t<s;t++)n[t]=n[t][2]/i;return n}),i("sd",function(t,e){const r=this.var(t,e),n=r.length;for(let t=0;t<n;t++)r[t]=Math.sqrt(r[t]);return r}),i("wrap",function(t,e){if(this._data_cube||b(this),t=a(r.single(t),0),"full"!==(e=a(r.single(e),"full"))&&"core"!==e&&"array"!==e)throw Error("'full', 'core', or 'array' expected");let n;if(-1===t)n=u(this),"array"!==e&&b(n),b(n=[n]);else{const[r,s,i]=this._s,o=this._k,l=t=>o&&o[t]?e=>o[t].get(e):t=>t;if(0===t){n=[1,s,i].cube();const t=l(1),r=l(2);for(let i of this.pages()){let o=r(i);for(let r of this.cols())n[t(r)+s*o]=this.sc(null,r,i,e)}}else if(1===t){n=[r,1,i].cube();const t=l(0),s=l(2);for(let i of this.pages()){let o=s(i);for(let s of this.rows())n[t(s)+r*o]=this.sc(s,null,i,e)}}else{if(2!==t)throw Error("invalid dimension");{n=[r,s,1].cube();const t=l(0),i=l(1);for(let s of this.cols()){let o=i(s);for(let i of this.rows())n[t(i)+r*o]=this.sc(i,s,null,e)}}}y(this,n,t),p(this,n,t)}return n})}i("toMatrix",function(){this._data_cube||b(this);const t=this.length;if(0===t)throw Error("non-empty array/cube expected");const e=Object.keys(this[0]),r=e.length,n=[t,r].cube();n.$key(1,e);for(let s=0;s<t;s++){let i=this[s];for(let o=0;o<r;o++)n[s+t*o]=i[e[o]]}return n}),i("which",function(t){this._data_cube||b(this),t=r.single(t);const e=this.length,n=new Array(e);let s=0;if(void 0!==t){r.func(t);for(let r=0;r<e;r++)t(this[r],r,this)&&(n[s++]=r)}else for(let t=0;t<e;t++)this[t]&&(n[s++]=t);return n.length=s,n})}return{}});
